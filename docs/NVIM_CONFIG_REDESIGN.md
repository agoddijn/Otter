# Neovim Configuration Redesign

## Current Problems

### 1. Race Condition
```
Plugin Loading (T1) → Reads _G.otter_config (empty!)
     vs
Python Config (T2) → Sends _G.otter_config (too late!)
```

### 2. LSP Not Attaching
- FileType autocmds registered but not firing
- No debug output visible
- `lspconfig.setup()` called but clients don't attach

### 3. Over-Engineering
- Complex lazy loading that doesn't work
- Manual LSP attachment attempts
- Timing dependencies everywhere

## Best Practices Research

### How Neovim LSP *Should* Work

**The Simple Way:**
```lua
require('lspconfig').pyright.setup{}
-- That's it! LSP automatically attaches to Python buffers
```

When you call `lspconfig.SERVER.setup{}`:
1. Registers a FileType autocmd internally
2. When Python file opens, autocmd fires
3. LSP client starts and attaches automatically
4. No manual intervention needed

### Industry Standard Patterns

**1. LazyVim / NvChad / AstroNvim Pattern:**
```lua
-- All config is Lua-native, no external dependencies
-- Simple, synchronous setup
require('lspconfig').pyright.setup{
    on_attach = function(client, bufnr)
        -- Keymaps, etc
    end,
    settings = { ... }
}
```

**2. For Headless/Programmatic:**
```lua
-- Pre-configure before Neovim starts
-- Pass config via environment or file
```

## Proposed Simplified Architecture

### Option A: Pre-Generated Config File (RECOMMENDED)

**Flow:**
```
Python Start
  ↓
1. Generate configs/runtime_config.lua with all settings
  ↓
2. Start Neovim: nvim -u init.lua
  ↓
3. init.lua loads runtime_config.lua (guaranteed to exist)
  ↓
4. Plugins load with config already available
  ↓
5. LSP attaches automatically (Neovim built-in behavior)
```

**Benefits:**
- ✅ No race condition (config file exists before Neovim starts)
- ✅ Simple, synchronous loading
- ✅ Uses Neovim's native LSP attachment
- ✅ Easy to debug (can inspect runtime_config.lua)
- ✅ Works with lazy.nvim's expectations

**Implementation:**
```python
# In Python: NeovimClient.start()
def _generate_runtime_config(self):
    """Generate Lua config file with all settings."""
    config_lua = f"""
-- Auto-generated by Otter
_G.otter_runtime_config = {{
    enabled_languages = {self._lua_repr(self.enabled_languages)},
    lsp = {{
        enabled = {str(self.config.lsp.enabled).lower()},
        servers = {{
            python = {{
                server = "{self.config.lsp.python.server or 'pyright'}",
                settings = {self._lua_repr(self.config.lsp.python.settings)},
            }},
            -- ... other languages
        }}
    }}
}}
"""
    runtime_config_path = self.config_dir / "runtime_config.lua"
    runtime_config_path.write_text(config_lua)
```

```lua
-- In init.lua
-- Load runtime config BEFORE plugins
require('runtime_config')  -- Sets _G.otter_runtime_config

-- Now load plugins with config available
require("lazy").setup(plugins)
```

```lua
-- In plugins.lua
{
    'neovim/nvim-lspconfig',
    config = function()
        local config = _G.otter_runtime_config or {}
        local lspconfig = require('lspconfig')
        
        -- Simple, direct setup - let Neovim handle attachment
        if config.enabled_languages.python then
            lspconfig.pyright.setup{
                settings = config.lsp.servers.python.settings
            }
        end
        
        if config.enabled_languages.javascript then
            lspconfig.tsserver.setup{}
        end
        
        -- That's it! No manual autocmds, no manual attachment
    end,
}
```

### Option B: Environment Variables

**Flow:**
```python
# Pass config via environment
os.environ['OTTER_ENABLED_LANGS'] = 'python,javascript'
os.environ['OTTER_LSP_CONFIG'] = json.dumps(lsp_config)
```

```lua
-- In Neovim
local langs = vim.split(vim.env.OTTER_ENABLED_LANGS or '', ',')
local lsp_config = vim.json.decode(vim.env.OTTER_LSP_CONFIG or '{}')
```

**Pros:** No file I/O
**Cons:** Environment size limits, harder to debug

### Option C: Simplified In-Process (Current, but fixed)

Keep current approach but:
1. Remove lazy loading complexity (just setup all LSPs)
2. Wait longer for Neovim to fully initialize
3. Reload LSP config after sending _G.otter_config

## Recommendation: Option A

**Why:**
1. **Eliminates race condition** completely
2. **Follows Neovim conventions** (config is just Lua)
3. **Debuggable** (can inspect generated file)
4. **Simple** (no timing tricks)
5. **Reliable** (config exists before Neovim starts)

## For Testing: Even Simpler

**Tests don't need lazy loading!** Just setup all LSPs immediately:

```lua
-- For test environments
if vim.env.OTTER_TEST_MODE == '1' then
    -- Setup all LSPs immediately, no lazy loading
    require('lspconfig').pyright.setup{}
    require('lspconfig').tsserver.setup{}
    require('lspconfig').rust_analyzer.setup{}
end
```

This makes tests:
- Faster (no waiting for FileType)
- More reliable (LSP always ready)
- Simpler (no autocmd timing issues)

## Migration Plan

### Phase 1: Generate Config File (Quick Win)
1. Add `_generate_runtime_config()` to Python
2. Modify `init.lua` to load runtime_config.lua
3. Simplify `plugins.lua` to use the config
4. Remove complex lazy loading logic

### Phase 2: Test Mode Optimization
1. Add `OTTER_TEST_MODE` environment variable
2. Setup all LSPs immediately in test mode
3. Remove polling delays

### Phase 3: Cleanup
1. Remove unused lazy loading code
2. Remove manual LSP attachment attempts
3. Update documentation

## Expected Results

**Before:**
- Race conditions
- LSP not attaching
- 15-30s timeout for tests
- Complex debugging

**After:**
- No race conditions
- LSP attaches automatically (Neovim's built-in behavior)
- <2s for LSP ready in tests
- Simple, debuggable config flow

## Key Insight

**We were fighting Neovim instead of working with it.**

Neovim's lspconfig already handles:
- FileType detection
- LSP attachment
- Buffer management

We just need to:
1. Call `lspconfig.SERVER.setup{}`
2. Let Neovim do its thing

Don't:
- ❌ Manually create FileType autocmds
- ❌ Manually call `LspStart`
- ❌ Manually attach to buffers
- ❌ Fight timing races

Do:
- ✅ Setup lspconfig early
- ✅ Trust Neovim's attachment
- ✅ Keep it simple

